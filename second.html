<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Connection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        #map {
            width: 100%;
            height: 400px;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #invitations {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        #invitations ul {
            list-style-type: none;
            padding: 0;
        }
        #invitations li {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <button id="connectBtn">Отправить приглашение устройству</button>
    <button id="invitationsBtn">Мои приглашения</button>
    
    <div id="invitations">
        <h3>Приглашения</h3>
        <ul id="invitationsList"></ul>
    </div>
    <div id="map"></div>

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <script>
        const ws = new WebSocket('ws://localhost:8080');
        const connectBtn = document.getElementById('connectBtn');
        const invitationsBtn = document.getElementById('invitationsBtn');
        const invitationsDiv = document.getElementById('invitations');
        const invitationsList = document.getElementById('invitationsList');
        let map, deviceMarker;
        let deviceId = localStorage.getItem('deviceId') || 'device-' + Math.random().toString(36).substr(2, 9);

        localStorage.setItem('deviceId', deviceId);

        ymaps.ready(initMap);

        function initMap() {
            map = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10
            });
            restoreMarkers();
        }

        function updateDeviceLocation(deviceId, lat, lon) {
            if (!deviceMarker) {
                deviceMarker = new ymaps.Placemark([lat, lon], {}, {
                    preset: 'islands#icon',
                    iconColor: '#0095b6'
                });
                map.geoObjects.add(deviceMarker);
            } else {
                deviceMarker.geometry.setCoordinates([lat, lon]);
            }
            map.setCenter([lat, lon]);
        }

        connectBtn.addEventListener('click', () => {
            const toDeviceId = prompt("Введите ID устройства, к которому вы хотите отправить приглашение:");
            if (toDeviceId) {
                ws.send(JSON.stringify({
                    type: 'sendInvitation',
                    from: deviceId,
                    to: toDeviceId
                }));
            }
        });

        invitationsBtn.addEventListener('click', () => {
            invitationsDiv.style.display = invitationsDiv.style.display === 'none' ? 'flex' : 'none';
        });

        ws.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'newInvitation':
                    if (data.to === deviceId) {
                        addInvitation(data.from);
                    }
                    break;
                case 'updateLocation':
                    if (data.device === deviceId) {
                        updateDeviceLocation(deviceId, data.lat, data.lon);
                    }
                    break;
                case 'invitationAccepted':
                    if (data.to === deviceId) {
                        alert(`Ваше приглашение принято устройством: ${data.from}`);
                        navigator.geolocation.watchPosition(position => {
                            const { latitude, longitude } = position.coords;
                            ws.send(JSON.stringify({
                                type: 'updateLocation',
                                device: data.from,
                                lat: latitude,
                                lon: longitude
                            }));
                        });
                    }
                    break;
                case 'invitationDeclined':
                    if (data.to === deviceId) {
                        alert(`Ваше приглашение отклонено устройством: ${data.from}`);
                    }
                    break;
            }
        });

        function addInvitation(from) {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                Устройство: ${from}
                <button onclick="acceptInvitation('${from}')">Принять</button>
                <button onclick="declineInvitation('${from}')">Отклонить</button>
            `;
            invitationsList.appendChild(listItem);
        }

        function acceptInvitation(from) {
            ws.send(JSON.stringify({
                type: 'acceptInvitation',
                from,
                to: deviceId
            }));

            navigator.geolocation.watchPosition(position => {
                const { latitude, longitude } = position.coords;
                ws.send(JSON.stringify({
                    type: 'updateLocation',
                    device: from,
                    lat: latitude,
                    lon: longitude
                }));
            });
        }

        function declineInvitation(from) {
            ws.send(JSON.stringify({
                type: 'declineInvitation',
                from,
                to: deviceId
            }));
        }

        function restoreMarkers() {
            const lat = localStorage.getItem('lat');
            const lon = localStorage.getItem('lon');
            if (lat && lon) {
                updateDeviceLocation(deviceId, parseFloat(lat), parseFloat(lon));
            }
        }

        // Восстановление состояния после перезагрузки
        window.addEventListener('load', () => {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    const { latitude, longitude } = position.coords;
                    localStorage.setItem('lat', latitude);
                    localStorage.setItem('lon', longitude);
                    ws.send(JSON.stringify({
                        type: 'updateLocation',
                        device: deviceId,
                        lat: latitude,
                        lon: longitude
                    }));
                });
            }
        });
    </script>
</body>
</html>
