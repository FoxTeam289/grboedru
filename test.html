<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Location Sharing</title>
    <style>
body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

.container {
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    width: 400px;
    text-align: center;
}

h1 {
    font-size: 24px;
    color: #333;
    margin-bottom: 20px;
}

.info {
    margin: 20px 0;
    font-size: 16px;
    color: #555;
}

button {
    background-color: #007bff;
    border: none;
    color: white;
    padding: 10px 20px;
    margin: 10px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #0056b3;
}

input {
    padding: 10px;
    margin: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
}

#map {
    width: 100%;
    height: 300px;
    margin: 20px 0;
}

.footer {
    margin-top: 20px;
    font-size: 14px;
    color: #777;
}

#langToggle {
    background-color: #28a745;
}

#langToggle:hover {
    background-color: #218838;
}

    </style>
</head>
<div id="container">
    <h1 id="title">Device Location Sharing</h1>
    <p id="deviceIdText">Your ID: <span id="deviceId"></span></p>
    <input type="text" id="requestIdInput" placeholder="Enter Device ID">
    <button id="requestBtn">Request Location</button>
    <button id="allowBtn">Allow Requests</button>
    <button id="realTimeBtn">Share my location in real-time</button>
    <button id="updateBtn">Update Connected Device Location</button>
    <button id="resetBtn">Reset All Devices</button>
    <button id="deleteBtn">Deny Permissions and Delete All My Data</button>
    <button id="hideIdBtn">Hide My ID</button>
    <p id="viewingDevicesText">Number of devices seeing my location: <span id="viewingDevicesCount"></span></p>
    <div id="map"></div>
    <p id="footerText">*We do not collect or distribute user data. All data is deleted when you click 'Deny Permissions and Delete All My Data'. We recommend clicking this button after each use.</p>
    <button id="langToggle">Switch to RU</button>
</div>
<script src="https://api-maps.yandex.ru/2.1/?lang=en_US" type="text/javascript"></script>
    <script>
 const LOCATION_UPDATE_INTERVAL = 5000; // 5 seconds

let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
document.getElementById('deviceId').innerText = deviceId;

function generateDeviceId() {
    let id = 'device-' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('deviceId', id);
    return id;
}

function getLocation() {
    return new Promise((resolve, reject) => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                });
            }, (error) => {
                reject(error);
            });
        } else {
            reject(new Error('Geolocation not supported.'));
        }
    });
}

async function allowRequests() {
    try {
        let location = await getLocation();
        localStorage.setItem(`location-${deviceId}`, JSON.stringify(location));
        saveToFile(deviceId, location);
        alert(getLocalizedText('requestsAllowed'));
    } catch (error) {
        console.error('Error allowing requests:', error);
        alert('Error allowing requests: ' + error.message);
    }
}

async function requestLocation() {
    let requestedDeviceId = document.getElementById('requestIdInput').value;
    let location = localStorage.getItem(`location-${requestedDeviceId}`);
    if (location) {
        location = JSON.parse(location);
        updateMap(location.latitude, location.longitude);
    } else {
        alert('Device not found.');
    }
}

async function shareLocationInRealTime() {
    try {
        await allowRequests();
        setInterval(async () => {
            try {
                let location = await getLocation();
                localStorage.setItem(`location-${deviceId}`, JSON.stringify(location));
                saveToFile(deviceId, location);
                console.log(getLocalizedText('realTimeUpdated'));
            } catch (error) {
                console.error('Error updating real-time location:', error);
            }
        }, LOCATION_UPDATE_INTERVAL);
    } catch (error) {
        console.error('Error enabling real-time updates:', error);
    }
}

function updateMap(latitude, longitude) {
    ymaps.ready(() => {
        let map = new ymaps.Map("map", {
            center: [latitude, longitude],
            zoom: 7
        });
        let placemark = new ymaps.Placemark([latitude, longitude], {}, {
            preset: 'islands#icon',
            iconColor: '#0095b6'
        });
        map.geoObjects.add(placemark);
        map.setCenter([latitude, longitude]);
    });
}

function resetAllDevices() {
    let keys = Object.keys(localStorage).filter(key => key.startsWith('location-'));
    keys.forEach(key => localStorage.removeItem(key));
    alert('All devices reset.');
}

function deleteAllData() {
    let keys = Object.keys(localStorage).filter(key => key.startsWith('location-'));
    keys.forEach(key => localStorage.removeItem(key));
    localStorage.removeItem('deviceId');
    location.reload();
}

function getLocalizedText(key) {
    const lang = localStorage.getItem('lang') || 'en';
    const texts = {
        en: {
            requestsAllowed: 'Requests allowed.',
            realTimeUpdated: 'Real-time location updated.'
        },
        ru: {
            requestsAllowed: 'Запросы разрешены.',
            realTimeUpdated: 'Геолокация в реальном времени обновлена.'
        }
    };
    return texts[lang][key];
}

function updateLanguage() {
    const lang = localStorage.getItem('lang') || 'en';
    document.getElementById('title').innerText = lang === 'en' ? 'Device Location Sharing' : 'Общий доступ к местоположению устройства';
 //   document.getElementById('deviceIdText').innerText = lang === 'en' ? 'Your ID: ' : 'Ваш ID: ';
 //   document.getElementById('viewingDevicesText').innerText = lang === 'en' ? 'Number of devices seeing my location: ' : 'Количество устройств, которые видят мое местоположение: ';
    document.getElementById('allowBtn').innerText = lang === 'en' ? 'Allow Requests' : 'Разрешить запросы';
    document.getElementById('realTimeBtn').innerText = lang === 'en' ? 'Share my location in real-time' : 'Передавать моё местоположение в реальном времени';
    document.getElementById('requestBtn').innerText = lang === 'en' ? 'Request Location' : 'Запросить местоположение';
    document.getElementById('updateBtn').innerText = lang === 'en' ? 'Update Connected Device Location' : 'Обновить местоположение подключённого устройства';
    document.getElementById('resetBtn').innerText = lang === 'en' ? 'Reset All Devices' : 'Сбросить все устройства';
    document.getElementById('deleteBtn').innerText = lang === 'en' ? 'Deny Permissions and Delete All My Data' : 'Запретить разрешения и удалить все данные обо мне';
    document.getElementById('langToggle').innerText = lang === 'en' ? 'Switch to RU' : 'Переключиться на EN';
    document.getElementById('footerText').innerText = lang === 'en' ? "*We do not collect or distribute user data. All data is deleted when you click 'Deny Permissions and Delete All My Data'. We recommend clicking this button after each use." : "*Мы не собираем данные о пользователе и не распространяем их. Все данные удаляются, при нажатии на кнопку 'Запретить разрешения и удалить все данные обо мне', советуем нажимать на неё после каждого похода.";
}

function saveToFile(deviceId, location) {
    // This function is a placeholder. Actual file operations cannot be performed with JavaScript alone on the client side.
    // It would require a server-side component to save data to a file.
    console.log(`Saving to file: ${deviceId}`, location);
}

document.getElementById('allowBtn').addEventListener('click', allowRequests);
document.getElementById('requestBtn').addEventListener('click', requestLocation);
document.getElementById('realTimeBtn').addEventListener('click', shareLocationInRealTime);
document.getElementById('updateBtn').addEventListener('click', async () => {
    let requestedDeviceId = document.getElementById('requestIdInput').value;
    let location = localStorage.getItem(`location-${requestedDeviceId}`);
    if (location) {
        location = JSON.parse(location);
        updateMap(location.latitude, location.longitude);
    } else {
        alert('Device not found.');
    }
});
document.getElementById('resetBtn').addEventListener('click', resetAllDevices);
document.getElementById('deleteBtn').addEventListener('click', deleteAllData);
document.getElementById('hideIdBtn').addEventListener('click', () => {
    document.getElementById('deviceIdText').style.display = 'none';
});
document.getElementById('langToggle').addEventListener('click', () => {
    let lang = localStorage.getItem('lang') === 'en' ? 'ru' : 'en';
    localStorage.setItem('lang', lang);
    updateLanguage();
});

updateLanguage();

    </script>
</body>
</html>
